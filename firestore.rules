rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Fungsi bantuan untuk memeriksa apakah pengguna adalah admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Pengguna dapat membaca/menulis data mereka sendiri, tetapi tidak data pengguna lain.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Admin dapat membaca semua profil pengguna
      allow read: if isAdmin();
    }

    // Pengaturan permainan dapat dibaca oleh semua pengguna terautentikasi.
    // Hanya admin yang dapat menulis ke pengaturan permainan.
    match /game-settings/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Gelar dapat dibaca oleh semua pengguna terautentikasi.
    // Hanya admin yang dapat membuat, memperbarui, atau menghapus gelar.
    match /titles/{titleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Aliansi dapat dibaca oleh semua pengguna terautentikasi.
    // Admin dapat membuat/menghapus aliansi. Pemimpin dapat memperbarui aliansi mereka.
    match /alliances/{allianceId} {
      allow read: if request.auth.uid != null;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || get(/databases/$(database)/documents/alliances/$(allianceId)).data.leaderId == request.auth.uid;
    }

    // Antrian konstruksi hanya dapat diakses oleh pengguna yang bersangkutan.
    match /constructionQueue/{jobId} {
      allow read, create, delete: if request.auth.uid == request.resource.data.userId;
    }
    
    // Antrian pelatihan hanya dapat diakses oleh pengguna yang bersangkutan.
    match /trainingQueue/{jobId} {
      allow read, create, delete: if request.auth.uid == request.resource.data.userId;
    }
    
    // Suara hanya dapat diakses oleh pengguna yang bersangkutan.
    match /votes/{userId} {
        allow read, write: if request.auth.uid == userId;
    }
    
    // Perang dapat dibaca oleh semua, tetapi hanya dapat dibuat oleh admin atau pemimpin aliansi.
    match /wars/{warId} {
        allow read: if request.auth.uid != null;
        allow create, delete: if isAdmin();
    }
    
    // Antrian serangan hanya dapat dibuat oleh penyerang.
    match /attackQueue/{missionId} {
      allow create: if request.resource.data.attackerId == request.auth.uid;
      // Aturan lain untuk read/delete akan lebih kompleks (misalnya, hanya untuk fungsi cloud)
    }
    
    // Laporan hanya dapat dibaca oleh pengguna yang terlibat.
    match /reports/{reportId} {
      allow read, update: if request.auth.uid in resource.data.involvedUsers;
    }
    
    // Log aktivitas hanya dapat dibuat (ditambahkan) oleh pengguna terautentikasi.
    match /activityLog/{logId} {
      allow create: if request.auth.uid != null;
    }

  }
}
